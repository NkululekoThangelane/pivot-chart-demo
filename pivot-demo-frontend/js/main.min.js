var PivotDataModel=Backbone.Model.extend({urlRoot:"/results",getQuestion:function(e){return"QS6_6"==e?"QS6_6: Where do you use each of the following services? (- Send a money transfer to a friend or family member -)":"Q30b"==e?"Q30b: Do any of the payment cards that you own allow you to use it without swiping it in a terminal by waving it in front of a reader to indicate a transaction if the store was equipped with the proper reader? Credit, charge, or debit cards like these are referred to as contactless cards and typically contain a symbol like the image below on the face of the card.":"Q31_1"==e?"Q31_1: Which Payment method do you prefer to use for online purchases for the following categories [Online Retailer (Shipped)]":void 0},getPivotQuery:function(e){var t={"01::Total":{match_all:{}},"02:Gender:Male":{match:{gender:"F"}},"03:Gender:Female":{match:{gender:"M"}},"04:Age:18 to 34":{range:{age:{from:"18",to:"34"}}},"05:Age:35 to 64":{range:{age:{from:"35",to:"64"}}},"06:Age:65 or Older":{range:{age:{from:"65"}}},"07:Household Income:Less than $50K":{range:{household_income:{to:"50"}}},"08:Household Income:$50K to $75K":{range:{household_income:{from:"50",to:"75"}}},"09:Household Income:$75K to $100K":{range:{household_income:{from:"75",to:"100"}}},"10:Household Income:$100K or more":{range:{household_income:{from:"100"}}}},i={query:{match_all:{}},aggs:{}};for(var n in t){var a=t[n];i.aggs[n]={filter:a,aggs:{answers:{terms:{field:e}}}}}return JSON.stringify(i)},updateResults:function(e){var t=this.getPivotQuery(e),i=this.getQuestion(e);this.fetch({data:{query:t},success:function(e,t,n){var a=t.res.aggregations,o={},r={},s=[],l=[],u={},d=[],h=-1;for(var c in a){var m=a[c].answers.buckets,p=c.split(":"),f=p[1],g=p[2];for(var v in m){var b=m[v];r[g]||(r[g]=1,l.push(g),o[f]?o[f]++:(o[f]=1,s.push(f),h++),d.push(h)),u[b.key]||(u[b.key]=[]),u[b.key].push({count:b.doc_count})}}e.set({question:i,titles:s,titleSpans:o,subtitles:l,entries:u,bgColorIds:d})},error:function(e,t,i){alert("ERROR: "+t)}})}}),SingleQuestionTableView=Backbone.View.extend({initialize:function(){this.model.on("change",this.render,this)},render:function(){var e=this.model.get("question"),t=this.model.get("titles"),i=this.model.get("titleSpans"),n=this.model.get("subtitles"),a=this.model.get("entries"),o=this.model.get("bgColorIds"),r=Handlebars.compile($("#pivot-table-tpl").html());for(var s in t){var l=t[s];t[s]={title:l,span:i[l],bgColorId:s}}for(var s in n){var u=n[s];n[s]={subtitle:u,bgColorId:o[s]}}var d=[];for(var h in a)for(var s in a[h]){var c=parseInt(a[h][s].count);d[s]||(d[s]=[]),d[s].push({x:h,y:c}),a[h][s].percentage=(100*c/1e5).toFixed(1),a[h][s].bgColorId=o[s]}var m=r({question:e,titles:t,titleSpans:i,subtitles:n,entries:a});this.$el.html(m);var p={xScale:"ordinal",yScale:"linear",main:[]};for(var s in d)p.main.push({className:".bar-chart-"+s,data:d[s]})}}),TableView=Backbone.View.extend({singleQuestionTableView:null,questionId:null,initialize:function(){this.pivotTableModel=new PivotDataModel,this.questionId="QS6_6",this.render()},render:function(){var e=Handlebars.compile($("#table-tpl").html()),t=e();this.$el.html(t),null==this.singleQuestionTableView&&(this.singleQuestionTableView=new SingleQuestionTableView({el:$("#pivot-table"),model:this.pivotTableModel})),this.updateResults()},updateResults:function(){this.pivotTableModel.updateResults(this.questionId)},events:{"click .question-select":"doQuestionSelect"},doQuestionSelect:function(e){var t=$(e.currentTarget).data("select");this.questionId=this.getQuestionId(this.questionId,t),this.updateResults()},getQuestionId:function(e,t){var i=["QS6_6","Q30b","Q31_1"],n=_.indexOf(i,e);return"prev"==t?(n--,0>n&&(n=i.length-1)):"next"==t&&(n++,n>i.length-1&&(n=0)),i[n]}}),SearchView=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=Handlebars.compile($("#search-tpl").html()),t=e();this.$el.html(t)},events:{"click button[id=submit-button]":"doSearch","click a[id=populate-sample-query]":"doPopulateSampleQuery"},doSearch:function(e){e.preventDefault();var t=$("#query-input").val();Backbone.history.navigate("search/"+encodeURIComponent(t)),$("#submit-button").attr("disabled","disabled"),$.get("/results",{query:t},function(e){$("#tokens-tpl").html();$("#results").empty();var t=1e3*e["total-time"];$("#results").append("<h2>Total Query Time</h2><p>"+t.toFixed(3)+"ms</p>"),$("#results").append("<h2>Raw Results</h2><pre>"+JSON.stringify(e,null,"	")+"</pre>"),$("#results-div").removeClass("hidden"),$("#submit-button").removeAttr("disabled")}).fail(function(){console.log("ERROR"),$("#results").empty(),$("#results").append("ERROR"),$("#results-div").removeClass("hidden"),$("#submit-button").removeAttr("disabled")})},doPopulateSampleQuery:function(e){e.preventDefault();var t=Handlebars.compile($("#sample-query-tpl").html())();$("#query-input").val(t)}}),FiltersView=Backbone.View.extend({questionIds:["QS6_6","Q30b","Q31_1"],initialize:function(){this.render(),this.on("trigger_update",this.doUpdateResult)},render:function(){var e=[];for(var t in this.questionIds){var i=this.questionIds[t],n=this.getQuestion(i);e.push({questionId:i,question:n,questionPreview:n.slice(0,30)+"..."})}var a=Handlebars.compile($("#filters-tpl").html());console.log(e);var o=a({questions:e});this.$el.html(o),$(".slider").slider()},events:{"change input":"doUpdateResult","change select":"doUpdateResult","slide input":"doUpdateSlider"},doUpdateSlider:function(e){var t=$(e.currentTarget),i=t.slider("getValue"),n=t.data("name");"age"==n?($("#age-text").html(i[0]+" to "+i[1]),$("#min-age-input").val(i[0]),$("#max-age-input").val(i[1])):"income"==n&&($("#income-text").html("$"+i[0]+"K to $"+i[1]+"K"),$("#min-income-input").val(i[0]),$("#max-income-input").val(i[1]))},getFilteredQuery:function(e,t,i,n,a,o,r){var s={};if(console.log(i),e||t||i||n||a&&!o||!a&&o){if(s.and=[],e||t){var l={};e&&(l.from=e),t&&(l.to=t),s.and.push({range:{age:l}})}if(i||n){var u={};i&&(u.from=i),n&&(u.to=n),s.and.push({range:{household_income:u}})}a&&!o?s.and.push({match:{gender:"F"}}):o&&!a&&s.and.push({match:{gender:"M"}})}return query={query:{filtered:{filter:s}},aggregations:{answers:{terms:{field:r}}}},JSON.stringify(query)},doUpdateResult:function(e){e.preventDefault();var t=this.$("#min-age-input").val(),i=this.$("#max-age-input").val(),n="M"==this.$("#gender-checkboxes-0:checked").val(),a="F"==this.$("#gender-checkboxes-1:checked").val(),o=this.$("#min-income-input").val(),r=this.$("#max-income-input").val(),s=this.$("#question-id-select").val();console.log(s);var l=this.getFilteredQuery(t,i,o,r,a,n,s);return $.get("/results",{query:l},function(e){var t=e.res.aggregations.answers.buckets,i=[],n=0;for(var a in t){var o=t[a];i.push({x:o.key,y:o.doc_count}),n+=o.doc_count}var e={xScale:"ordinal",yScale:"linear",main:[{className:".bar-chart",data:i}]};new xChart("bar",e,"#filters-chart");$("#filters-total").html("<p>Total Count: "+n+"</p>")}),!1},getQuestion:function(e){return"QS6_6"==e?"QS6_6: Where do you use each of the following services? (- Send a money transfer to a friend or family member -)":"Q30b"==e?"Q30b: Do any of the payment cards that you own allow you to use it without swiping it in a terminal by waving it in front of a reader to indicate a transaction if the store was equipped with the proper reader? Credit, charge, or debit cards like these are referred to as contactless cards and typically contain a symbol like the image below on the face of the card.":"Q31_1"==e?"Q31_1: Which Payment method do you prefer to use for online purchases for the following categories [Online Retailer (Shipped)]":void 0}}),MainView=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=Handlebars.compile($("#main-tpl").html()),t=e();this.$el.html(t)},events:{"click a[class=select-mode]":"doSelectMode"},doSelectMode:function(e){e.preventDefault();var t=$(e.currentTarget).data("mode");Backbone.history.navigate(t,!0)}}),AppRouter=Backbone.Router.extend({main:null,tableView:null,searchView:null,filtersView:null,graphsView:null,initialize:function(){this.main=new MainView({el:$("#main-view")})},routes:{table:"handleTable",search:"handleSearch","search/:query":"handleSearch",filters:"handleFilters","*actions":"handleDefault"},handleDefault:function(){this.navigate("table",!0)},handleTable:function(){this._hideAllContentDivs(),null==this.tableView&&(this.tableView=new TableView({el:$("#table-view")})),this.tableView.$el.show()},handleSearch:function(e){this._hideAllContentDivs(),null==this.searchView&&(this.searchView=new SearchView({el:$("#search-view")})),$("#query-input").val(e),this.searchView.$el.show()},handleFilters:function(){this._hideAllContentDivs(),null==this.filtersView&&(this.filtersView=new FiltersView({el:$("#filters-view")})),this.filtersView.$el.find("input").first().trigger("change"),this.filtersView.$el.show()},_hideAllContentDivs:function(){$("#content").children("div").hide()}});$(document).ready(function(){router=new AppRouter,Backbone.history.start({pushState:!0})});